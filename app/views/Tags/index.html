#{extends 'main.html' /}

<style type="text/css">
    ul {
        list-style: none;
    }

    li {
        padding: 5px;
        margin: 5px;
        -webkit-border-radius: 5px;
        background-color: #eff3f7;
        padding-left: 20px;
        color: gray;
    }
    
    .grouped {
        background-color: white;
        padding: 10px;
        margin: 5px;
        -webkit-border-radius: 5px;
        border: 1px solid #cccccc;
    }

    .grouped .name {
        color: #408dda;
        font-size: 12pt;
        margin-bottom: 10px;
    }

    #pageContainer {
        overflow: hidden;
    }

    #tagGroupContainer {
        float: left;
        width: 60%;
        margin-right: 4%;
    }

    .tag {
        padding-left: 20px;
    }

    .handle {
        width: 15px;
        height: 15px;
        float:left;
        margin-right: 10px;
        background-image: url("/public/images/drag-icon.gif");
        cursor: move;
    }

    .placeholder {
        background-color: #cccccc;
    }
</style>

<script type="text/javascript">
    $(function() {
        $(".groupSelector").change(function() {
            var tagId = $(this).attr("name");
            var groupId = $(this).attr("value");

            $.ajax({
                type: 'POST',
                url: '@{Tags.assignGroup()}',
                data: {'tagId':tagId,'groupId':groupId},
                success: function(data) {
                    location.reload();
                }
            });
        });

        $(".mutexCheckbox").change(function(e) {
            var groupId = $(this).attr("value");
            var isMutex = $(this).attr("checked");

            $.ajax({
                type: 'POST',
                url: '@{Tags.changeMutex()}',
                data: {'isMutex':isMutex,'groupId':groupId},
                success: function(data) {
                    location.reload();
                }
            });
        });

        $(".defaultSelector").change(function(e) {
            var groupId = $(this).attr("name");
            var tagId = $(this).attr("value");

            $.ajax({
                type: 'POST',
                url: '@{Tags.setDefault()}',
                data: {'tagId':tagId,'groupId':groupId},
                success: function(data) {
                    location.reload();
                }
            });
        });

        $('.tags').sortable({
            items : ".tag",
            handle : $(".handle"),
            placeholder : 'placeholder',
            update : function(event, ui) {
                $.post("/tags/sort", $(this).sortable('serialize'));
            }
        });

        $('.tagGroups').sortable({
            items : ".tagGroup",
            handle : $(".handle"),
            placeholder : 'placeholder',
            update : function(event, ui) {
                $.post("/tags/sortGroup", $(this).sortable('serialize'));
            }
        });
    });
</script>

<div id="pageContainer">
    <div id="tagGroupContainer">
        <h1>Tags <a href="@{TagGroups.create()}">(add new group)</a> <a href="@{Tags.create()}">(add new tag)</a></h1>        

        <ul class="tagGroups">
            #{list models.TagGroup.getAll(), as: "tagGroup"}
               <li class="tagGroup grouped" id="tagGroups-${tagGroup.id}">
                   <div class="handle"></div>
                   <div style="float:right;"><input class="mutexCheckbox" type="checkbox" name="mutex" value="${tagGroup.id}" #{if tagGroup.mutex}checked#{/if}/> Mutually exclusive tags</div>
                   <div class="name">${tagGroup.name}</div>
                   <div style="text-align: right;">Default</div>
                   <ul class="tags">
                        #{list tagGroup.tags, as: "tag"}
                            <li class="tag" id="tags-${tag.id}"><div class="handle"></div>${tag.name}
                                <div style="float:right;">
                                   #{select tag.id, items: models.TagGroup.findAll(), valueProperty:'id', value: tag.group?.id, labelProperty:'title', class: 'groupSelector'}
                                   #{/select}<a onclick="return confirm('Are you sure you want to delete this tag?');" href="@{Tags.delete(tag.id)}">delete</a>
                                    <input type="radio" class="defaultSelector" name="${tagGroup.id}" value="${tag.id}" #{if tagGroup.defaultTag?.equals(tag)}checked#{/if}/>
                                </div>
                            </li>
                        #{/list}
                   </ul>
               </li>
            #{/list}
        </ul>
    </div>
</div>