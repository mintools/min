#{set isNew: !task?.id/}

<div class="task" data-id="${task?.id}" data-editMode="${editMode}" data-isNew="${isNew}">

    #{if !editMode}
        <div class="hoverActions">
            <div class="hoverAction insertAboveButton hide"></div>
            <div class="hoverAction moveUpButton hide"></div>
            <div class="hoverAction taskId hide">${task?.id}</div>
            <div class="hoverAction moveDownButton hide"></div>
            <div class="hoverAction insertBelowButton hide"></div>
        </div>
        <div class="move">
            <img src="@{'/public/images/arrow-move.png'}"/>
        </div>

        <div class="display">
            <div class="title">
                <h3>${task.title?.raw()}</h3>
                <div class="assignedTo">
                    #{if task?.assignedTo}Assigned to ${task?.assignedTo}#{/if}#{else}Unassigned#{/else}
                </div>
                <div class="createdBy">
                    Creator: ${task?.owner}
                </div>
            </div>
            <div class="main">
                <div class="description descriptionSummary">
                    ${task.content?.nl2br()}
                </div>
                #{if task.tags}
                <div class="tags">
                    #{list task.tags, as: "tag"}
                    <div class="tag">
                        ${tag}
                    </div>
                    #{/list}
                </div>
                #{/if}
            </div>
            <div class="comments">
                #{list task?.comments, as: "comment"}
                #{include "Tasks/comment.html"/}
                #{/list}
            </div>
            <div class="taskInterests">
                #{list task?.interestedMembers, as: "member"}
                #{include "Members/taskInterest.html"/}
                #{/list}
            </div>
            <div class="thumbnails">
                #{list task?.attachments, as:'attachment'}
                #{include 'Attachments/attachment.html'/}
                #{/list}
            </div>
            <div class="editingButtons">
                <a href="javascript:void(0);" class="editButton button ui-state-default ui-corner-all right">Edit</a>
            </div>
        </div>
        <div class="clear">
        </div>
    #{/if}

    #{else}
        #{ifErrors}
            <p class="error">
                Please fix the validation errors
            </p>
        #{/ifErrors}

        <div class="display">
            #{form class:'taskForm', action:@Tasks.save(), method:'post', enctype:'multipart/form-data' }
                <input type="hidden" name="task.id" value="${task?.id}"/>

                <div class="title">
                    <label for="task.title">Title</label><br/>
                    <div class="titleField">
                        <div contentEditable="true" class="taskTitleField">${task?.title?.raw()}</div>
                    </div>
                    <span class="error">${errors.forKey('task.title')}</span>

                    <div class="assignedTo">
                        Assign to:
                        #{select 'task.assignedTo.id', items: models.Member.findAll(), valueProperty:'id', value: task?.assignedTo?.id, labelProperty:'username'}
                        #{option} Unassigned #{/option}
                    #{/select}
                    </div>
                    <div class="createdBy">
                        Creator: ${task?.owner}
                    </div>
                </div>
                <div class="main">
                    <label for="task.content">Description</label><br/>
                    <div class="description descriptionSummary">
                        <div contentEditable="true" class="taskContentField">${task?.content?.raw()}</div>
                    </div>
                    <span class="error">${errors.forKey('task.content')}</span>
                    <div class="tags">
                        <label for="selectedTags">Tags</label>
                        <div class="selectedTags">
                            <input class="tagContainer" type="text" name="selectedTags" value="${task?.tags?.join(' ')}"/>
                        </div>
                    </div>
                    <div>
                        <label for="attachments">Add Attachments</label>
                        <input type="file" name="attachments" class="multi"/>
                    </div>
                </div>
                <div class="comments">
                    #{list task?.comments, as: "comment"}
                    #{include "Tasks/comment.html"/}
                    #{/list}
                </div>
                <div class="taskInterests">
                    #{list task?.interestedMembers, as: "member"}
                    #{include "Members/taskInterest.html"/}
                    #{/list}
                </div>
                <div class="thumbnails">
                    #{list task?.attachments, as:'attachment'}
                    #{include 'Attachments/attachment.html'/}
                    #{/list}
                </div>
                <div class="editingButtons">
                    <a href="javascript:void(0);" class="cancelButton button ui-state-default ui-corner-all right">Cancel</a>
                    #{if !isNew}<a href="javascript:void(0);" class="deleteButton button ui-state-default ui-corner-all right">Delete</a>#{/if}
                    <a href="javascript:void(0);" class="saveButton button ui-state-default ui-corner-all right">Save</a>
                </div>
            #{/form}
        </div>        
        <div class="clear">
        </div>
    #{/else}
</div>